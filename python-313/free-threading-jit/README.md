# Python 3.13 Preview: Free Threading and a JIT Compiler

This repository contains sample code and data files for the [Python 3.13 Preview: Free Threading and a JIT Compiler](https://realpython.com/python313-free-threading-jit/) tutorial on Real Python.

## Build the Docker Image

Build Python 3.13 from source code using Docker:

```sh
$ docker image build --tag pythons .
```

**Note:** If you want to compile your C extension modules, then you'll need to keep the intermediate stage with the required build tools:

```sh
$ docker build --target stock-builder --tag builder .
$ docker image build --tag pythons .
```

## Run Performance Benchmarks Using Docker

Change directory to the `benchmarks/` folder:

```sh
$ cd benchmarks/
```

### Free Threading

Run the benchmark against Python 3.12 shipped with the system:

```sh
$ docker run --rm -v "$(pwd)":/app -w /app pythons python3.12 gil.py --threads=4
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.12.3 /usr/bin/python3.12
Free Threading: unsupported
JIT Compiler: unsupported
======================================================
Running 4 threads: 7.33s
```

Run the benchmark against stock Python 3.13:

```sh
$ docker run --rm -v "$(pwd)":/app -w /app pythons python3.13 gil.py --threads=4
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.13.0rc1 /usr/local/bin/python3.13
Free Threading: unsupported
JIT Compiler: unsupported
======================================================
Running 4 threads: 7.51s
```

Run the benchmark against the free-threaded Python 3.13 build with the GIL and JIT disabled:

```sh
$ docker run --rm -v "$(pwd)":/app -w /app -e PYTHON_JIT=0 pythons python3.13t gil.py --threads=4
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.13.0rc1 /usr/local/bin/python3.13t
Free Threading: enabled ✨
JIT Compiler: disabled
======================================================
Running 4 threads: 3.25s
```

Run the benchmark against the free-threaded Python 3.13 build with the GIL enabled and JIT disabled:

```sh
$ docker run --rm -v "$(pwd)":/app -w /app -e PYTHON_JIT=0 pythons python3.13t -X gil=1 gil.py --threads=4
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.13.0rc1 /usr/local/bin/python3.13t
Free Threading: disabled
JIT Compiler: disabled
======================================================
Running 4 threads: 13.72s
```

### Just-In-Time (JIT) Compiler

Run the benchmark against Python 3.12 shipped with the system:

```sh
$ docker run --rm -v "$(pwd)":/app -w /app pythons python3.12 jit.py -n 10000
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.12.3 /usr/bin/python3.12
Free Threading: unsupported
JIT Compiler: unsupported
======================================================
Running fib() 10,000 times: 6.06s
```

Run the benchmark against stock Python 3.13:

```sh
$ docker run --rm -v "$(pwd)":/app -w /app pythons python3.13 jit.py -n 10000
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.13.0rc1 /usr/local/bin/python3.13
Free Threading: unsupported
JIT Compiler: unsupported
======================================================
Running fib() 10,000 times: 5.68s
```

Run the benchmark against Python 3.13 with the JIT enabled but GIL unsupported:

```sh
$ docker run --rm -v "$(pwd)":/app -w /app pythons python3.13j jit.py -n 10000
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.13.0rc1 /usr/local/bin/python3.13j
Free Threading: unsupported
JIT Compiler: enabled ✨
======================================================
Running fib() 10,000 times: 5.27s
```

## Disassemble JIT's Micro-Ops

Reveal mico-ops generated by the JIT compiler: 

```sh
$ cd benchmarks/
$ docker run --rm -it -v "$(pwd)":/app -w /app pythons python3.13j -i uops.py
======================================================
💻 Linux 64bit with 4x CPU cores (x86_64 Little Endian)
🐍 CPython 3.13.0rc1 /usr/local/bin/python3.13j
Free Threading: unsupported
JIT Compiler: enabled ✨
======================================================
>>> def fib(n):
...     a, b = 0, 1
...     for _ in range(n):
...         a, b = b, a + b
...     return a
...

>>> fib(10)
55

>>> reveal_code(fib)
Micro-ops unavailable

>>> fib(10)
55

>>> reveal_code(fib)
_START_EXECUTOR
_TIER2_RESUME_CHECK
_ITER_CHECK_RANGE
_GUARD_NOT_EXHAUSTED_RANGE
_ITER_NEXT_RANGE
_STORE_FAST_3
_LOAD_FAST_2
_LOAD_FAST_1
_LOAD_FAST_2
_GUARD_BOTH_INT
_BINARY_OP_ADD_INT
_STORE_FAST_2
_STORE_FAST_1
_JUMP_TO_TOP
_DEOPT
_EXIT_TRACE
_EXIT_TRACE
_ERROR_POP_N
_EXIT_TRACE
_ERROR_POP_N
```

## Compile the C Extension Module

Build an intermediate stage with the necessary build tools if you haven't before:

```shell
$ docker build --target stock-builder --tag builder .
```

Change directory to the `c_extension/` folder:

```sh
$ cd c_extension/
```

Start a Docker container from the builder stage and set common compiler flags:

```sh
$ docker run --rm -it -v "$(pwd)":/app -w /app builder
root@8312f61fbb6d:/app# CFLAGS='-shared -fPIC -O3'
```

Compile the `greeter` module for stock Python 3.13:

```sh
root@8312f61fbb6d:/app# gcc greeter.c $CFLAGS \
                        $(python3.13-config --includes) \
                        -o greeter_stock.so
```

Compile the `greeter` module for the free-threaded Python 3.13:

```sh
root@8312f61fbb6d:/app# gcc greeter.c $CFLAGS \
                        $(python3.13t-config --includes) \
                        -o greeter_threaded_v1.so
```

Compile the `greeter_threaded` module for the free-threaded Python 3.13:

```sh
root@8312f61fbb6d:/app# gcc greeter_threaded.c $CFLAGS \
                        $(python3.13t-config --includes) \
                        -o greeter_threaded_v2.so
```
